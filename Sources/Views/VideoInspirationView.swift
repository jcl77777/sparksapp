import SwiftUI
import CoreData

struct VideoInspirationView: View {
    @Environment(\.presentationMode) var presentationMode
    @EnvironmentObject var viewModel: InspirationViewModel
    @EnvironmentObject var appState: AppState
    let onComplete: (Int) -> Void
    
    @State private var videoURL: String = ""
    @State private var videoTitle: String = ""
    @State private var videoThumbnail: String = ""
    @State private var description: String = ""
    @State private var selectedTags: Set<String> = []
    @State private var isLoading = false
    @State private var showingSuccessView = false
    @State private var savedInspiration: Inspiration?
    @State private var showAddTaskSheet = false
    @State private var errorMessage: String?
    
    var body: some View {
        if showingSuccessView {
            ScrollView {
                VStack(spacing: 0) {
                    // Success Header
                    GradientHeader(
                        title: "‚úì " + NSLocalizedString("video_success", comment: "ÂÑ≤Â≠òÊàêÂäüÔºÅ"),
                        gradientColors: AppDesign.Colors.purpleGradient
                    )

                    VStack(spacing: AppDesign.Spacing.large) {
                        Text("‚úì")
                            .font(.system(size: 80, design: .monospaced))
                            .foregroundColor(AppDesign.Colors.purple)

                        Text(NSLocalizedString("video_saved", comment: "ÂΩ±ÁâáÂ∑≤ÊàêÂäüÂÑ≤Â≠òÂà∞Êî∂Ëóè"))
                            .font(.system(size: AppDesign.Typography.bodySize, design: .monospaced))
                            .foregroundColor(AppDesign.Colors.textSecondary)

                        VStack(spacing: AppDesign.Spacing.small) {
                            PixelButton(
                                "‚ûï " + NSLocalizedString("video_add_task", comment: "Êñ∞Â¢û‰ªªÂãô"),
                                color: AppDesign.Colors.green
                            ) {
                                showAddTaskSheet = true
                            }

                            PixelButton(
                                "‚úì " + NSLocalizedString("video_done", comment: "ÂÆåÊàê"),
                                style: .secondary,
                                color: AppDesign.Colors.gray
                            ) {
                                onComplete(0) // Ë∑≥Âà∞ Collection ÂàÜÈ†Å
                            }
                        }
                    }
                    .padding(AppDesign.Spacing.standard)
                }
            }
            .sheet(isPresented: $showAddTaskSheet) {
                AddTaskView(inspiration: savedInspiration)
            }
        } else {
            ScrollView {
                VStack(spacing: 0) {
                    // Gradient Header
                    GradientHeader(
                        title: "üé¨ " + NSLocalizedString("add_video_title", comment: "Êñ∞Â¢ûÂΩ±Áâá"),
                        gradientColors: AppDesign.Colors.purpleGradient
                    )

                    VStack(spacing: AppDesign.Spacing.standard) {
                        // ÂΩ±ÁâáÈÄ£Áµê
                        VStack(alignment: .leading, spacing: AppDesign.Spacing.small) {
                            Text(NSLocalizedString("video_url_title", comment: "ÂΩ±ÁâáÈÄ£Áµê"))
                                .font(.system(size: AppDesign.Typography.bodySize, weight: .bold, design: .monospaced))
                                .foregroundColor(AppDesign.Colors.textPrimary)

                            HStack(spacing: AppDesign.Spacing.small) {
                                PixelTextField(
                                    text: $videoURL,
                                    placeholder: NSLocalizedString("video_url_placeholder", comment: "Ëº∏ÂÖ•ÂΩ±ÁâáÈÄ£Áµê"),
                                    icon: "üé¨",
                                    keyboardType: .URL,
                                    autocapitalization: .never
                                )
                                .onChange(of: videoURL) { _, newValue in
                                    // Áï∂URLËÆäÂåñÊôÇÔºåËá™ÂãïÊäìÂèñÂΩ±ÁâáË≥áË®ä
                                    if !newValue.isEmpty && isValidVideoURL(newValue) {
                                        fetchVideoInfo()
                                    }
                                }

                                Button(action: fetchVideoInfo) {
                                    Text("‚¨áÔ∏è")
                                        .font(.system(size: 20))
                                }
                                .disabled(videoURL.isEmpty || isLoading)
                                .opacity(videoURL.isEmpty || isLoading ? 0.5 : 1.0)
                            }

                            if isLoading {
                                HStack {
                                    ProgressView()
                                        .scaleEffect(0.8)
                                    Text(NSLocalizedString("video_loading", comment: "Ê≠£Âú®ÊäìÂèñÂΩ±ÁâáË≥áË®ä..."))
                                        .font(.system(size: AppDesign.Typography.labelSize, design: .monospaced))
                                        .foregroundColor(AppDesign.Colors.textSecondary)
                                }
                            }

                            if let errorMessage = errorMessage {
                                Text(errorMessage)
                                    .font(.system(size: AppDesign.Typography.labelSize, design: .monospaced))
                                    .foregroundColor(.red)
                            }
                        }


                        // ÂΩ±ÁâáÈ†êË¶Ω
                        if !videoTitle.isEmpty {
                            VStack(alignment: .leading, spacing: AppDesign.Spacing.small) {
                                Text(NSLocalizedString("video_preview", comment: "ÂΩ±ÁâáÈ†êË¶Ω"))
                                    .font(.system(size: AppDesign.Typography.bodySize, weight: .bold, design: .monospaced))
                                    .foregroundColor(AppDesign.Colors.textPrimary)

                                PixelCard(borderColor: AppDesign.Colors.purple) {
                                    VStack(alignment: .leading, spacing: AppDesign.Spacing.small) {
                                        HStack {
                                            Text("üé¨")
                                                .font(.system(size: 20))
                                            Text(videoTitle)
                                                .font(.system(size: AppDesign.Typography.bodySize, weight: .bold, design: .monospaced))
                                                .foregroundColor(AppDesign.Colors.textPrimary)
                                                .lineLimit(2)
                                        }

                                        Text(videoURL)
                                            .font(.system(size: AppDesign.Typography.labelSize, design: .monospaced))
                                            .foregroundColor(AppDesign.Colors.textSecondary)
                                            .lineLimit(1)

                                        // ÂΩ±ÁâáÈ†êË¶ΩÂúñÁ§∫
                                        RoundedRectangle(cornerRadius: AppDesign.Borders.radiusCard)
                                            .fill(Color(.systemGray5))
                                            .frame(height: 120)
                                            .overlay(
                                                VStack(spacing: AppDesign.Spacing.small) {
                                                    Text("üé¨")
                                                        .font(.system(size: 32))
                                                    Text(NSLocalizedString("video_preview", comment: "ÂΩ±ÁâáÈ†êË¶Ω"))
                                                        .font(.system(size: AppDesign.Typography.labelSize, design: .monospaced))
                                                        .foregroundColor(AppDesign.Colors.textSecondary)
                                                }
                                            )
                                    }
                                    .padding(AppDesign.Spacing.standard)
                                }
                            }
                        }

                        // Ê®ôÈ°å
                        VStack(alignment: .leading, spacing: AppDesign.Spacing.small) {
                            Text(NSLocalizedString("video_title", comment: "Ê®ôÈ°å"))
                                .font(.system(size: AppDesign.Typography.bodySize, weight: .bold, design: .monospaced))
                                .foregroundColor(AppDesign.Colors.textPrimary)

                            PixelTextField(
                                text: $videoTitle,
                                placeholder: NSLocalizedString("video_title_placeholder", comment: "Ëº∏ÂÖ•Ê®ôÈ°å"),
                                icon: "üìù"
                            )
                        }

                        // ÊèèËø∞
                        VStack(alignment: .leading, spacing: AppDesign.Spacing.small) {
                            Text(NSLocalizedString("video_description_optional", comment: "ÊèèËø∞ÔºàÂèØÈÅ∏Ôºâ"))
                                .font(.system(size: AppDesign.Typography.bodySize, weight: .bold, design: .monospaced))
                                .foregroundColor(AppDesign.Colors.textPrimary)

                            PixelTextEditor(
                                text: $description,
                                placeholder: NSLocalizedString("video_description_optional", comment: "Ëº∏ÂÖ•ÊèèËø∞"),
                                minHeight: 100,
                                icon: "üìù"
                            )
                        }

                        // Ê®ôÁ±§
                        VStack(alignment: .leading, spacing: AppDesign.Spacing.small) {
                            Text(NSLocalizedString("video_tags_optional", comment: "Ê®ôÁ±§ÔºàÂèØÈÅ∏Ôºâ"))
                                .font(.system(size: AppDesign.Typography.bodySize, weight: .bold, design: .monospaced))
                                .foregroundColor(AppDesign.Colors.textPrimary)

                            if viewModel.availableTags.isEmpty {
                                Text(NSLocalizedString("video_no_tags", comment: "ÁÑ°ÂèØÁî®Ê®ôÁ±§ÔºåË´ãËá≥Ë®≠ÂÆöÈ†ÅÊñ∞Â¢û"))
                                    .font(.system(size: AppDesign.Typography.bodySize, design: .monospaced))
                                    .foregroundColor(AppDesign.Colors.textSecondary)
                                    .italic()
                            } else {
                                VStack(spacing: AppDesign.Spacing.small) {
                                    ForEach(viewModel.availableTags, id: \.objectID) { tag in
                                        MultipleSelectionRow(title: tag.name ?? "", isSelected: selectedTags.contains(tag.name ?? "")) {
                                            let name = tag.name ?? ""
                                            if selectedTags.contains(name) {
                                                selectedTags.remove(name)
                                            } else {
                                                selectedTags.insert(name)
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        // ÊåâÈàïÂçÄÂüü
                        VStack(spacing: AppDesign.Spacing.small) {
                            PixelButton(
                                "üíæ " + NSLocalizedString("video_save", comment: "ÂÑ≤Â≠ò"),
                                color: AppDesign.Colors.purple
                            ) {
                                saveVideoInspiration()
                            }
                            .disabled(videoTitle.trimmingCharacters(in: .whitespaces).isEmpty || videoURL.isEmpty)
                            .opacity((videoTitle.trimmingCharacters(in: .whitespaces).isEmpty || videoURL.isEmpty) ? 0.5 : 1.0)

                            PixelButton(
                                NSLocalizedString("video_cancel", comment: "ÂèñÊ∂à"),
                                style: .secondary,
                                color: AppDesign.Colors.gray
                            ) {
                                presentationMode.wrappedValue.dismiss()
                            }
                        }
                        .padding(.top, AppDesign.Spacing.small)
                    }
                    .padding(AppDesign.Spacing.standard)
                }
            }
        }
    }
    
    private func isValidVideoURL(_ url: String) -> Bool {
        let videoDomains = [
            "youtube.com", "youtu.be", "www.youtube.com",
            "vimeo.com", "www.vimeo.com",
            "dailymotion.com", "www.dailymotion.com",
            "twitch.tv", "www.twitch.tv"
        ]
        
        return videoDomains.contains { domain in
            url.lowercased().contains(domain)
        }
    }
    
    private func fetchVideoInfo() {
        if URL(string: videoURL) != nil {
            // ÈÅøÂÖçÈáçË§áÊäìÂèñ
            if isLoading {
                return
            }
            
            isLoading = true
            errorMessage = nil
            
            // ÈÄôË£°ÂèØ‰ª•ÂØ¶‰ΩúÂΩ±ÁâáË≥áË®äÊäìÂèñÈÇèËºØ
            // ÁõÆÂâçÂÖàÊ®°Êì¨ÊäìÂèñÈÅéÁ®ã
            DispatchQueue.main.asyncAfter(deadline: .now() + 1.5) {
                isLoading = false
                
                // Ê®°Êì¨Âæû‰∏çÂêåÂπ≥Âè∞ÊäìÂèñÂΩ±ÁâáË≥áË®ä
                if videoURL.contains("youtube.com") || videoURL.contains("youtu.be") {
                    videoTitle = "YouTube ÂΩ±Áâá"
                    videoThumbnail = ""
                } else if videoURL.contains("vimeo.com") {
                    videoTitle = "Vimeo ÂΩ±Áâá"
                    videoThumbnail = ""
                } else if videoURL.contains("twitch.tv") {
                    videoTitle = "Twitch ÂΩ±Áâá"
                    videoThumbnail = ""
                } else if videoURL.contains("dailymotion.com") {
                    videoTitle = "Dailymotion ÂΩ±Áâá"
                    videoThumbnail = ""
                } else {
                    videoTitle = "ÂΩ±ÁâáÈÄ£Áµê"
                    videoThumbnail = ""
                }
            }
        } else {
            errorMessage = "ÁÑ°ÊïàÁöÑÂΩ±ÁâáÈÄ£ÁµêÊ†ºÂºè"
        }
    }
    
    private func saveVideoInspiration() {
        let inspiration = Inspiration(context: viewModel.context)
        inspiration.id = UUID()
        inspiration.title = videoTitle.isEmpty ? "ÔºàÊú™ÂëΩÂêçÔºâ" : videoTitle
        inspiration.content = description.isEmpty ? nil : description
        inspiration.url = videoURL.isEmpty ? "" : videoURL
        inspiration.type = 3 // ÂΩ±ÁâáÈ°ûÂûã
        inspiration.createdAt = Date()
        inspiration.updatedAt = Date()
        
        // Ë®≠ÂÆöÊ®ôÁ±§
        for tagName in selectedTags {
            if let tag = viewModel.availableTags.first(where: { $0.name == tagName }) {
                inspiration.addToTags(tag)
            }
        }
        
        // ‰ΩøÁî® ViewModel ÁöÑ saveContext ÊñπÊ≥ïÔºåÁ¢∫‰øùË≥áÊñôÂêåÊ≠•
        viewModel.saveContext()
        savedInspiration = inspiration
        
        // Ê∑ªÂä†Âª∂ÈÅ≤‰æÜÈÅøÂÖç List Ê∏≤ÊüìÂïèÈ°å
        DispatchQueue.main.asyncAfter(deadline: .now() + 0.3) {
            showingSuccessView = true
        }
    }
}

struct VideoInspirationView_Previews: PreviewProvider {
    static var previews: some View {
        VideoInspirationView(onComplete: { _ in })
            .environmentObject(InspirationViewModel(context: PersistenceController.preview.container.viewContext))
            .environmentObject(AppState.shared)
    }
} 